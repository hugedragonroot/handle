M130T总线通信协议（V1.0.0）

------

[TOC]

## 版本

| 版本号    | 日期         | 修订内容 | 修改人  |
| ------ | ---------- | ---- | ---- |
| V1.0.0 | 2022/11/14 | 初版   | 李攀桂  |
|        |            |      |      |
|        |            |      |      |

## 概述	

- 本协议为了统一总线通信格式而设置，尽最大程度完成应用层协议功能需求。
- 本协议基于modbus协议进行修改，基于modbus协议寄存器的概念上添加组合，订阅，注册等功能，针对modbus协议多个寄存器只能连续操作做出优化。


- 该协议可用于公司所有可自定义协议应用之间的通信。

- 以往普通协议的数据单元里大多以一个固定的结构体数据发送接收，一旦需求更改结构体更改，上层和下层都需要同步改。用寄存器组合形式，无论需求如何改动，下层只需要在自己的寄存器表后面添加需求，上层更新新的寄存器地址进行操作即可。

  ​

## 基于Modbus协议的：xsto_api_ii:1.0.0

### 协议格式说明：

* PDU位协议中的数据单元，具体请参考 **协议数据单元（PDU ）数据协议说明**

| 帧头    | 类型    | 功能码   | 保留位   | 数据长度  | PDU数据单元 | CRC   |
| ----- | ----- | ----- | ----- | ----- | ------- | ----- |
| 2Byte | 2Byte | 1Byte | 1Byte | 2Byte | N Byte  | 2Byte |

- 帧头（head）：0x5a 0x5a

- 类型（type）：高8bit：模块号，底8bit：模块索引号。

  ​	例如：八路驱动器，两个单片机分别模块号为0x10，0x20。每个单片机底下的电机为模块索引号0x01，0x02,0x03,0x04。整理合成type：0x1001等。

- 功能码（cmd）：读，写，注册，订阅，心跳，升级等。

- 数据长度：除帧头和CRC校验外的数据长度，N+6，用于解析器解析

- 保留位（reserve）：预留

- PDU数据单元（PDU）：

  - 正常通信的PDU:   包含msgID，length，data[]。
  - 异常通信的PDU：包含msgID，length，error（异常码）。


- CRC校验：从类型开始到PDU数据单元最后一位（包括PDU数据单元最后一位）进行校验。

------

### 协议数据单元（PDU）数据协议说明：



#### 正常通信的协议数据单元（PDU）:

| 序号   | 内容     | 字节   | 类型       | 描述                        |
| ---- | ------ | ---- | -------- | ------------------------- |
| 1    | msgID  | 1    | uint8_t  | 请求时自定义的id号，应答时根据id号确定消息   |
| 2    | length | 2    | uint16_t | 这个长度表示下面data[]的数据长度，占两个字节 |
| 3    | data[] | N    | uint8_t  | 数据内容，长度为length            |

msgID：消息标记号，返回的标记就是请求时的标记。



#### 异常通信的协议数据单元（PDU）：

| 序号   | 内容     | 字节   | 类型       | 描述                        |
| ---- | ------ | ---- | -------- | ------------------------- |
| 1    | msgID  | 1    | uint8_t  | 请求时自定义的id号，应答时根据id号确定消息   |
| 2    | length | 2    | uint16_t | 值 == 0x0001，占两个字节         |
| 3    | excC   | 1    | uint8_t  | 异常码：区分出现的各种异常，后面会具体介绍有哪些值 |

errc值：功能码+0x80

#### 功能码、差错码、异常码取值说明：



##### 功能码

| 序号   | funC值 | 描述            |
| ---- | ----- | ------------- |
| 1    | 0x03  | 读设备指定数据组合的数据  |
| 2    | 0x04  | 写设备指定数据组合的数据  |
| 3    | 0x05  | 订阅设备指定数据组合的数据 |



##### 差错码

差错码 = 功能码+0x80

| 序号   | errC值 | 描述                |
| ---- | ----- | ----------------- |
| 1    | 0x83  | 读指定数据组合的数据出现错误    |
| 2    | 0x84  | 写指定数据组合的数据出现错误    |
| 3    | 0x85  | 订阅指定数据组合的数据出现错误   |
| 4    | 0x86  | 取消订阅指定数据组合的数据出现错误 |
| 5    | 0x87  | 查看订阅列表出现错误        |



##### 异常码

| 序号   | excC值 | 描述       |
| ---- | ----- | -------- |
| 1    | 0x01  | 不支持的功能码  |
| 2    | 0x02  | 地址超出范围   |
| 3    | 0x03  | 数量超出范围   |
| 4    | 0x04  | 其他读取失败错误 |

#### 设备注册信息（功能码（CMD）：0x01）



##### 从机设备请求注册设备信息	 (CMD:0X01)

| 序号   | 内容    | 字节   | 类型       | 描述                     |
| ---- | ----- | ---- | -------- | ---------------------- |
| 1    | 固件版本号 | 4    | uint32_t | 软件版本号：1.0.0.1，每个数占1个字节 |
| 2    | 硬件版本号 | 4    | uint32_t | 硬件版本号：1.0.0.1，每个数占1个字节 |
| 3    | CPUID | 12   | uint32_t | 自定义的CUPID，为后面固件升级使用    |
| 4    | 超时时间  | 2    | uint16_t | 心跳维持的超时时间              |
| 5    | 在线状态  | 1    | uint8_t  | 0:不在线，1：在线             |



##### 主机设备应答注册信息 (CMD:0X01)

| 序号   | 内容   | 字节   | 类型       | 描述      |
| ---- | ---- | ---- | -------- | ------- |
| 1    | 心跳时间 | 4    | uint32_t | 系统当时的心跳 |

#### 设备注册心跳在线功能（功能码（CMD）：0x02）



##### 从机设备发送心跳	 (CMD:0X02)

| 序号   | 内容   | 字节   | 类型       | 描述          |
| ---- | ---- | ---- | -------- | ----------- |
| 1    | 心跳时间 | 4    | uint32_t | 1ms的滴答时间心跳值 |





#### 读设备指定数据组合的数据（功能码（CMD）: 0x03）

​	

##### 请求协议数据单元（PDU） (CMD:0X03)

| 序号   | 内容           | 字节      | 类型       | 描述                             |
| ---- | ------------ | ------- | -------- | ------------------------------ |
| 1    | msgID        | 1       | uint8_t  | 0x00-0xFF                      |
| 2    | length       | 2       | uint16_t | 0x0000-0xFFFF（1+4*N(N：多少个组合)）  |
| 3    | combineCount | 1       | uint8_t  | 数据组合项个数 N                      |
| 4    | address+size | (2+2)*N | uint16_t | address：寄存器地址、size：读从地址开始的多少字节 |



##### 响应协议数据单元（PDU） (CMD:0X03)

| 序号   | 内容     | 字节   | 类型       | 描述                           |
| ---- | ------ | ---- | -------- | ---------------------------- |
| 1    | msgID  | 1    | uint8_t  | 0x00-0xFF                    |
| 2    | length | 2    | uint16_t | 0x0000-0xFFFF（请求的数据组合中长度之和 ） |
| 3    | data[] | N    | uint16_t | 以数据组合顺序返回对应的值                |

返回时length的值为请求的数据组合中长度之和 ，因为data的类型为uint8_t。



##### 错误	（CMD:0X83）

| 序号   | 内容     | 字节   | 类型       | 描述              |
| ---- | ------ | ---- | -------- | --------------- |
| 1    | msgID  | 1    | uint8_t  | 0x00-0xFF       |
| 2    | length | 2    | uint16_t | 0x0001          |
| 3    | excC   | 1    | uint8_t  | 异常码：01/02/03/04 |

#### 写设备指定数据组合的数据（功能码（CMD）: 0x04）



##### 请求协议数据单元（PDU） (CMD:0X04)

| 序号   | 内容                  | 字节           | 类型       | 描述                                       |
| ---- | ------------------- | ------------ | -------- | ---------------------------------------- |
| 1    | msgID               | 1            | uint8_t  | 0x00-0xFF                                |
| 2    | length              | 2            | uint16_t | 0x0000-0xFFFF（（1+4* N+M[1-N] (M：一个数据项的写入数据长度。N：多少个组合)） |
| 3    | combineCount        | 1            | uint8_t  | 数据组合项个数 N ：0x00-0xFF                     |
| 4    | address+size+data[] | (2+2+M)[1-N] | uint16_t | address(uint16_t)：数据地址、size(uint16_t)：写从地址开始的多少字节、data(uint16_t * M)：写入的数据内容 |



##### 响应协议数据单元（PDU） (CMD:0X04)

| 序号   | 内容     | 字节   | 类型       | 描述                     |
| ---- | ------ | ---- | -------- | ---------------------- |
| 1    | msgID  | 1    | uint8_t  | 0x00-0xFF              |
| 2    | length | 2    | uint16_t | 0x0002                 |
| 3    | size   | 2    | uint16_t | 成功写入的数据长度（所有组合的size之和） |



##### 错误	(CMD:0X84)

| 序号   | 内容     | 字节   | 长度       | 描述              |
| ---- | ------ | ---- | -------- | --------------- |
| 1    | msgID  | 1    | uint8_t  | 0x00-0xFF       |
| 2    | length | 2    | uint16_t | 0x0001          |
| 3    | excC   | 1    | uint8_t  | 异常码：01/02/03/04 |

#### 订阅数据（功能码（CMD）:0x05）

订阅不同组合以msgID区分，相同msgID覆盖前面的订阅；



##### 请求协议数据单元（PDU）(CMD:0X05)

| 序号   | 内容           | 字节      | 类型       | 描述                                  |
| ---- | ------------ | ------- | -------- | ----------------------------------- |
| 1    | msgID        | 1       | uint8_t  | 0x00-0xFF                           |
| 2    | length       | 2       | uint16_t | 0x0000-0xFFFF（2+1+2*N (N：数据组合项个数 )） |
| 3    | timing       | 2       | uint16_t | 定时发 /ms；填 0 是以触发方式返回数据，有外部触发才返回数据   |
| 4    | combineCount | 1       | uint8_t  | 数据组合项个数 N ：0x00-0xFF                |
| 5    | address+size | (2+2)*N | uint16_t | address：数据地址、size：订阅从地址开始的多少字节      |



##### 响应协议数据单元（PDU）(CMD:0X05)

| 序号   | 内容     | 字节   | 类型       | 描述                           |
| ---- | ------ | ---- | -------- | ---------------------------- |
| 1    | funC   | 1    | uint8_t  | 功能码：0x05                     |
| 2    | msgID  | 1    | uint8_t  | 0x00-0xFF                    |
| 3    | length | 2    | uint16_t | 0x0000-0xFFFF（请求的数据组合中长度之和 ） |
| 4    | data[] | N    | uint8_t  | 以数据组合顺序返回对应的值                |



##### 错误	(CMD:0X85)

| 序号   | 内容     | 字节   | 类型       | 描述              |
| ---- | ------ | ---- | -------- | --------------- |
| 1    | msgID  | 1    | uint8_t  | 0x00-0xFF       |
| 2    | length | 2    | uint16_t | 0x0001          |
| 3    | excC   | 1    | uint8_t  | 异常码：01/02/03/04 |



#### 取消订阅（功能码（CMD）: 0x06）



##### 请求协议数据单元（PDU）(CMD:0X06)

| 序号   | 内容     | 字节   | 类型       | 描述           |
| ---- | ------ | ---- | -------- | ------------ |
| 1    | funC   | 1    | uint8_t  | 功能码：0x06     |
| 2    | msgID  | 1    | uint8_t  | 0x00-0xFF    |
| 3    | length | 2    | uint16_t | N（需要取消N个订阅）  |
| 4    | data[] | N    | uint8_t  | 需要取消的订阅msgID |

data[]中填订阅时使用的msgID来区分取消哪些订阅



##### 响应协议数据单元（PDU）(CMD:0X06)

| 序号   | 内容     | 字节   | 类型       | 描述        |
| ---- | ------ | ---- | -------- | --------- |
| 1    | msgID  | 1    | uint8_t  | 0x00-0xFF |
| 2    | length | 2    | uint16_t | 0x0001    |
| 3    | data[] | 1    | uint8_t  | 取消成功N个    |



##### 错误	(CMD:0X86)

| 序号   | 内容     | 字节   | 类型       | 描述              |
| ---- | ------ | ---- | -------- | --------------- |
| 1    | msgID  | 1    | uint8_t  | 0x00-0xFF       |
| 2    | length | 2    | uint16_t | 0x0001          |
| 3    | excC   | 1    | uint8_t  | 异常码：01/02/03/04 |





#### 查看订阅列表（功能码(CMD) :0x07）



##### 请求协议数据单元（PDU）(CMD:0X07)

| 序号   | 内容    | 字节   | 类型      | 描述        |
| ---- | ----- | ---- | ------- | --------- |
| 1    | msgID | 1    | uint8_t | 0x00-0xFF |



##### 响应协议数据单元（PDU）(CMD:0X07)

| 序号    | 内容                | 字节          | 类型           | 描述                                    |
| ----- | ----------------- | ----------- | ------------ | ------------------------------------- |
| 1     | msgID             | 1           | uint8_t      | 0x00-0xFF                             |
| 2     | length            | 2           | uint16_t     | 1+(4+4*N)[M]（[M]组相加）                  |
| 3     | listCount         | 1           | uint8_t      | M个订阅                                  |
| **4** | **ID**            | **1**       | **uint8_t**  | **订阅时填的msgID，取消订阅时填这个**               |
| **5** | **timing**        | **2**       | **uint16_t** | **定时发 /ms；填 0 是以触发方式返回数据，有外部触发才返回数据** |
| **6** | **combineCount**  | **1**       | **uint8_t**  | **数据组合项个数 N ：0x00-0xFF**              |
| **7** | **address+size ** | **(2+2)*N** | **uint16_t** | **address：数据地址、size：订阅从地址开始的多少字节**    |
| ...   |                   |             |              |                                       |

注意：订阅个数M是以序号4，5，6，7为一个单元





##### 错误

| 序号   | 内容     | 字节   | 类型       | 描述              |
| ---- | ------ | ---- | -------- | --------------- |
| 1    | errC   | 1    | uint8_t  | 差错码：0x87        |
| 2    | msgID  | 1    | uint8_t  | 0x00-0xFF       |
| 3    | length | 2    | uint16_t | 0x0001          |
| 4    | excC   | 1    | uint8_t  | 异常码：01/02/03/04 |







## 使用示例：

### 步骤一：设置数据寄存器表述文档

数据寄存器寻址表及功能表述如下：

驱动器一的数据寄存器寻址表如下：

| 地址     | 类型       | 变量名                  | 描述         | 操作方式 |
| ------ | -------- | -------------------- | ---------- | ---- |
| 0x0000 | uint32_t | Firmware_version     | 固件版本号      | R    |
| 0x0004 | uint32_t | Hardware_version     | 硬件版本号      | R    |
| 0x0008 | uint16_t | Motor1_state         | 电机1状态      | R    |
| 0x000A | uint8_t  | Motor1_mode          | 电机1工作模式    | R/W  |
| 0x000B | float    | Motor1_set_angle     | 电机1设定角度    | R/W  |
| 0x000F | float    | Motor1_real_angle    | 电机1真实角度    | R    |
| 0x0013 | int16_t  | Motor1_set_speed     | 电机1设定速度    | R/W  |
| 0x0015 | int16_t  | Motor1_real_speed    | 电机1真实速度    | R    |
| 0x0017 | int16_t  | Motor1_set_current   | 电机1设定电流    | R/W  |
| 0x0019 | int16_t  | Motor1_real_current  | 电机1真实电流    | R    |
| ...... |          |                      |            |      |
| 0x008B | uint16_t | Motor8_state         | 电机8状态      | R    |
| 0x008D | uint8_t  | Motor8_mode          | 电机8工作模式    | R/W  |
| 0x008E | float    | Motor8_set_angle     | 电机8设定角度    | R/W  |
| 0x0092 | float    | Motor8_real_angle    | 电机8真实角度    | R    |
| 0x0096 | int16_t  | Motor8_setl_speed    | 电机8设定速度    | R/W  |
| 0x0098 | int16_t  | Motor8_real_speed    | 电机8真实速度    | R    |
| 0x009A | int16_t  | Motor8_set_current   | 电机8设定电流    | R/W  |
| 0x009C | int16_t  | Motor8_real_current  | 电机8真实电流    | R    |
| 0x009E | float    | Chassis_Pitch        | 底盘俯仰角      | R    |
| 0x00A2 | float    | Chair_Pitch          | 座椅俯仰角      | R    |
| 0x00A6 | uint16_t | Ultrasonic1_distance | 超声波1距离（mm） |      |
| ...... |          |                      |            |      |

------文档结束------

### 步骤二：使用范例





#### 读取数据协议单元（PDU）（CMD:0X03）



例如读取 0x0000：Firmware_version 和 0x008B-0x009C：Motor8_state 这两组数据：

| 序号   | 内容           | 字节   | 类型       | 描述                     |
| ---- | ------------ | ---- | -------- | ---------------------- |
| 1    | msgID        | 1    | uint8_t  | 0x01                   |
| 2    | length       | 2    | uint16_t | 0x0009（1+4*N(N：多少个组合)） |
| 3    | combineCount | 1    | uint8_t  | 2                      |
| 4    | address      | 2    | uint16_t | 0x0000                 |
| 5    | size         | 2    | uint16_t | 0x0004                 |
| 6    | address      | 2    | uint16_t | 0x008B                 |
| 7    | size         | 2    | uint16_t | 0x0013                 |



响应协议数据单元（PDU）(CMD:0X03)



| 序号   | 内容               | 字节   | 类型       | 描述                    |
| ---- | ---------------- | ---- | -------- | --------------------- |
| 1    | msgID            | 1    | uint8_t  | 0x01                  |
| 2    | length           | 2    | uint16_t | 0x001D（请求的数据组合中长度之和 ） |
| 3    | Firmware_version | 4    | uint16_t | 0x10000001            |
| 4    | Motor8_state     | 19   | uint16_t | 0x00  0x0101 .......  |

返回时length的值为请求的数据组合中长度之和 。

注意：都是使用小端格式！



#### 写入协议数据单元（PDU）（CMD:0X04）



例如修改 Motor1_mode=0x02 和 Motor1_set_speed=0xBB8这两组数据：

| 序号   | 内容               | 字节   | 类型       | 描述                                       |
| ---- | ---------------- | ---- | -------- | ---------------------------------------- |
| 1    | msgID            | 1    | uint8_t  | 0x01                                     |
| 2    | length           | 2    | uint16_t | 0x000C（1+4* N+M[1-N] (M：一个数据项的写入数据长度N：多少个组合)） |
| 3    | combineCount     | 1    | uint8_t  | 0x02                                     |
| 4    | address          | 2    | uint16_t | 0x000A                                   |
| 5    | size             | 2    | uint16_t | 0x0001                                   |
| 6    | Motor1_mode      | 1    | uint8_t  | 0x02                                     |
| 7    | address          | 2    | uint16_t | 0x0013                                   |
| 8    | size             | 2    | uint16_t | 0x0002                                   |
| 9    | Motor1_set_speed | 2    | int16_t  | 0x0BB8                                   |



响应协议数据单元（PDU）(0X04)

| 序号   | 内容     | 字节   | 类型       | 描述     |
| ---- | ------ | ---- | -------- | ------ |
| 1    | msgID  | 1    | uint8_t  | 0x01   |
| 2    | length | 2    | uint16_t | 0x0002 |
| 3    | size   | 2    | uint16_t | 0x0003 |



#### 订阅协议数据单元（PDU）（CMD:0x05）

例如订阅数据Motor1_state，Motor1_mode，Motor1_real_angle，Motor8_real_speed：

| 序号   | 内容           | 字节   | 类型       | 描述                                       |
| ---- | ------------ | ---- | -------- | ---------------------------------------- |
| 1    | msgID        | 1    | uint8_t  | 0x01（用于区分订阅组合）                           |
| 2    | length       | 2    | uint16_t | 0x000F（4+M (M：数据内容字节长度)）                 |
| 3    | timing       | 2    | uint16_t | 0x0064（100ms周期），填 0 是以触发方式返回数据，有外部触发才返回数据 |
| 4    | combineCount | 1    | uint8_t  | 数据组合项个数 N ：0x00-0xFF                     |
| 5    | address1     | 2    | uint16_t | 0x0008                                   |
| 6    | size1        | 2    | uint16_t | 0x0003                                   |
| 7    | address2     | 2    | uint16_t | 0x000F                                   |
| 8    | size2        | 2    | uint16_t | 0x0004                                   |
| 9    | address3     | 2    | uint16_t | 0x0013                                   |
| 10   | size3        | 2    | uint16_t | 0X0002                                   |



从机响应订阅数据（CMD:0X05）

| 序号   | 内容                | 字节   | 类型       | 描述                       |
| ---- | ----------------- | ---- | -------- | ------------------------ |
| 1    | msgID             | 1    | uint8_t  | 0x01（用于区分订阅组合）           |
| 1    | length            | 2    | uint16_t | 0x0009（4+M (M：数据内容字节长度)） |
| 2    | Motor1_state      | 2    | uint16_t | 0x0100                   |
| 3    | Motor1_mode       | 1    | uint8_t  | 0x0006                   |
| 4    | Motor1_real_angle | 4    | float    | 360.01                   |
| 5    | Motor8_real_speed | 2    | int16_t  | 0x0bb8                   |

